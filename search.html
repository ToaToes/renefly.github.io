<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flight Search</title>
  <link rel="stylesheet" href="style_search.css" />
</head>
<body>

  <h2>航线搜索</h2>

  <form id="flightForm">
    <!-- Ban user from choosing previous date before today -->
    <label for="flightDate">日期:</label>
    <input type="date" id="flightDate" name="flightDate" min="" required />

    <label for="departure">出发地:</label>
    <input type="text" id="departure" name="departure" placeholder="输入出发城市" autocomplete="off" required />
    <div id="departureResult" ></div>

    <label for="arrival">到达地:</label>
    <input type="text" id="arrival" name="arrival" placeholder="输入到达城市" autocomplete="off" required />
    <div id="arrivalResult" ></div>

    
    <!-- Class Dropdown -->
    <div class="dropdown-checkbox">
      <label for="class-select">舱等:</label>
      <button type="button" id="class-button" onclick="toggleDropdown('class')">请选择舱等 (默认全选)</button>
      <div class="options" id="class-options">
        <!-- 默认全选 -->
        <!-- <label><input type="checkbox" value="all" onchange="updateButtonText('class')"> 默认全部</label> -->
        <label><input type="checkbox" name="class" value="economy" onchange="updateButtonText('class')" checked> 经济</label>
        <label><input type="checkbox" name="class" value="super_economy" onchange="updateButtonText('class')" checked> 超级经济</label>
        <label><input type="checkbox" name="class" value="business" onchange="updateButtonText('class')" checked> 商务</label>
        <label><input type="checkbox" name="class" value="first" onchange="updateButtonText('class')" checked> 头等</label>
      </div>
    </div>


    <!-- Airline Dropdown -->
    <div class="dropdown-checkbox">
      <label for="airline-select">航司:</label>
      <button type="button" id="airline-button" onclick="toggleDropdown('airline')">请选择航空公司 (默认全选)</button>
      <div class="options" id="airline-options">
        <!-- 默认全选 -->
        <!-- <label><input type="checkbox" value="all" onchange="updateButtonText('airline')"> 默认全部</label> -->
        <label><input type="checkbox" name="airline" value="AA" onchange="updateButtonText('airline')" checked> 美国航空 - AA</label>
        <label><input type="checkbox" name="airline" value="AS" onchange="updateButtonText('airline')" checked> 阿拉斯加航空 - AS</label>
        <label><input type="checkbox" name="airline" value="BA" onchange="updateButtonText('airline')" checked> 英国航空 - BA</label>
        <label><input type="checkbox" name="airline" value="AF" onchange="updateButtonText('airline')" checked> 法国航空 - AF</label>
        <label><input type="checkbox" name="airline" value="UA" onchange="updateButtonText('airline')" checked> 美联航 - UA</label>
        <label><input type="checkbox" name="airline" value="AC" onchange="updateButtonText('airline')" checked> 加拿大航空 - AC</label>
        <label><input type="checkbox" name="airline" value="CX" onchange="updateButtonText('airline')" checked> 国泰航空 - CX</label>
      </div>
    </div>


    <label for="directFlight" style="margin-bottom: 15px; display: inline-block;">
      <input type="checkbox" id="directFlight" name="directFlight" />
      仅限直飞
    </label>

    <button type="submit" id="submitBtn">搜索航班</button>
  </form>

  <!-- associate with IATA code, from json -->
  <script src="IATA_association.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.3.0/firebase-auth-compat.js"></script>

  <!-- Firebase Config -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyBjBXmXps-wu6qIudSdD_0aGNri6WiM3vU",
      authDomain: "loginauth-8662e.firebaseapp.com",
      projectId: "loginauth-8662e",
      storageBucket: "loginauth-8662e.firebasestorage.app",
      messagingSenderId: "542087917375",
      appId: "1:542087917375:web:deb096e402681ac4756d8a",
      measurementId: "G-DK6XZBH36G"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // Protect this page
    auth.onAuthStateChanged(user => {
      if (!user || !user.emailVerified) {
        window.location.href = "index.html";
      }
    });
  </script>

  <script>
    function toggleDropdown(type) {
      const classOptions = document.getElementById("class-options");
      const airlineOptions = document.getElementById("airline-options");

      if (type === "class") {
        classOptions.style.display = classOptions.style.display === "block" ? "none" : "block";
        airlineOptions.style.display = "none"; // Close the other
      } else if (type === "airline") {
        airlineOptions.style.display = airlineOptions.style.display === "block" ? "none" : "block";
        classOptions.style.display = "none"; // Close the other
      }
    }


    // Close any dropdown when clicking outside
    window.addEventListener('click', function (e) {
      const dropdowns = document.querySelectorAll('.dropdown-checkbox');
      dropdowns.forEach(dropdown => {
        if (!dropdown.contains(e.target)) {
          const options = dropdown.querySelector('.options');
          if (options) options.style.display = 'none';
        }
      });
    });

  </script>

  <!-- Press enter key to hit button -->
  <script>
    // Let the form handle its own submission
    document.getElementById("flightForm").addEventListener("keydown", function (event) {
      if (event.key === "Enter") {
        // Only block Enter when dropdowns are open
        const classOptions = document.getElementById("class-options");
        const airlineOptions = document.getElementById("airline-options");

        if (classOptions.style.display === "block" || airlineOptions.style.display === "block") {
          event.preventDefault(); // prevent accidental submits when dropdown is open
        } else {
          event.preventDefault(); // stop default to control it
          document.getElementById("submitBtn").click(); // simulate submit button click
        }

      }
    });
  </script>


  <script>
    const flightDateInput = document.getElementById("flightDate");

    // Detect date change, then close the picker automatically
    flightDateInput.addEventListener("change", () => {
      // Blur removes focus, which closes the picker UI
      flightDateInput.blur(); // Close date picker
      document.activeElement.blur(); // Also close virtual keyboard
    });
  </script>

  
  <script>
    // set date min is today
    const today = new Date().toISOString().split("T")[0];
    document.getElementById("flightDate").setAttribute("min", today);

  </script>


  <!-- submit -->
  <script>
    console.log("script loaded");
    // ----------------------
    // 1. Block form submit when checkbox group is empty
    // ----------------------
    document.getElementById("flightForm").addEventListener("submit", function (e) {

      e.preventDefault(); // ← 确保先阻止默认刷新

      const noClassChecked = document.querySelectorAll('#class-options input[type="checkbox"]:checked').length === 0;
      const noAirlineChecked = document.querySelectorAll('#airline-options input[type="checkbox"]:checked').length === 0;

      if (noClassChecked || noAirlineChecked) {
        

        if (noClassChecked) {
          document.getElementById("class-button").textContent = "请至少选择一个舱等";
          alert("请至少选择一个舱等");
        }
        if (noAirlineChecked) {
          document.getElementById("airline-button").textContent = "请至少选择一个航空公司";
          alert("请至少选择一个航空公司");
        }

        return; // stop form
      }

      // ban user manually input previous date
      document.getElementById("flightForm").addEventListener("submit", function (e) {
        const inputDate = document.getElementById("flightDate").value;
        const today = new Date().toISOString().split("T")[0];
        if (inputDate < today) {
          e.preventDefault();
          alert("不能选择过去的日期！");
          return;
        }
      });

      // ----------------------
      // submit 
      // ----------------------
      const formData = new FormData(this);
      const params = new URLSearchParams();

      ["class", "airline"].forEach(name => {
        const values = formData.getAll(name);
        if (values.length === 0) {
          params.append(name, "all");
        } else {
          values.forEach(v => params.append(name, v));
        }
      });

      ["flightDate", "departure", "arrival", "directFlight"].forEach(name => {
        if (formData.has(name)) {
          params.append(name, formData.get(name));
        }
      });

      console.log("URL params:", params.toString());

      window.location.href = "loading.html?" + params.toString();
    });

    // ----------------------
    // 2. Update button text when checkboxes change
    // ----------------------
    function updateButtonText(type) {
      let checkboxes, button, emptyMessage;

      if (type === "class") {
        checkboxes = document.querySelectorAll('#class-options input[type="checkbox"]');
        button = document.getElementById("class-button");
        emptyMessage = "请至少选择一个舱等";
      } else if (type === "airline") {
        checkboxes = document.querySelectorAll('#airline-options input[type="checkbox"]');
        button = document.getElementById("airline-button");
        emptyMessage = "请至少选择一个航空公司";
      }

      const selected = [];
      checkboxes.forEach(cb => {
        if (cb.checked) {
          selected.push(cb.parentNode.textContent.trim());
        }
      });

      if (selected.length > 0) {
        button.textContent = selected.join(', ');
      } else {
        button.textContent = emptyMessage;
      }
    }
  </script>


</body>
</html>
